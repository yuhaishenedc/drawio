<mxfile host="app.diagrams.net" modified="2024-02-09T03:08:59.714Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0" etag="wLwTcs5WhTTO-oyI4cxe" version="23.1.2" type="github">
  <diagram name="第 1 页" id="U_HhLAPaVu63GRcEfQPl">
    <mxGraphModel dx="1545" dy="3165" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="591SITI4Ghsz0lOfu50e-1" value="&lt;div&gt;class WebThreadImpl : public blink::WebThread {&lt;/div&gt;&lt;div&gt;public:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; explicit WebThreadImpl(const char* name);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual ~WebThreadImpl();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static const int kDefaultPriority = 100;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static const int kLoadingPriority = 200;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual void postTask(const blink::WebTraceLocation&amp;amp;, blink::WebThread::Task*) override;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual void postDelayedTask(const blink::WebTraceLocation&amp;amp;, blink::WebThread::Task*, long long delayMs) override;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void postDelayedTaskWithPriorityCrossThread(const blink::WebTraceLocation&amp;amp; location,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; blink::WebThread::Task* task,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long long delayMs,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int priority);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual bool isCurrentThread() const override;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual blink::PlatformThreadId threadId() const override;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual void addTaskObserver(TaskObserver*) override;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual void removeTaskObserver(TaskObserver*) override;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; // Returns the scheduler associated with the thread.&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; virtual blink::WebScheduler* scheduler() const override;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void willExit();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void startTriggerTasks();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void schedulerTasks();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool hasImmediatelyTimer();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void fire();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void suspendTimerQueue();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void resumeTimerQueue();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void cancelTimerTask(WebThread::Task* task);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void disableScheduler();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void enableScheduler();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; std::vector&amp;lt;WebTimerBase*&amp;gt;&amp;amp; timerHeap();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void updateSharedTimer();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void appendUnusedTimerToDelete(WebTimerBase* timer) { m_unusedTimersToDelete.push_back(timer); }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool threadClosed() { return m_threadClosed; }&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void shutdown();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static unsigned getNewCurrentHeapInsertionOrder();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;private:&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void fireOnExit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void waitForExit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void fireTimeOnExit();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; struct TaskPair {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; TaskPair(const blink::WebTraceLocation&amp;amp; location, blink::WebThread::Task* task, long long delayMs, int priority);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; static void sortByPriority(std::vector&amp;lt;TaskPair*&amp;gt;*);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; blink::WebTraceLocation location;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; blink::WebThread::Task* task;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; long long delayMs;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; int priority;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; double createTime;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; unsigned heapInsertionOrder;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; };&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void postDelayedTaskImpl(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; const blink::WebTraceLocation&amp;amp; location, blink::WebThread::Task* task, long long delayMs, double* createTimeOnOtherThread, int priority, unsigned* heapInsertionOrder);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static DWORD __stdcall WebThreadImplThreadEntryPoint(void* param);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void threadEntryPoint();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void deleteUnusedTimers();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void deleteTimersOnExit();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void deleteTaskPairsToPostOnExit();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void willProcessTasks();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void didProcessTasks();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; void clearEmptyObservers();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HANDLE m_hEvent;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; blink::PlatformThreadId m_threadId;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_willExit;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_threadClosed;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; int m_firingTimers; // Reentrancy guard.&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; WebSchedulerImpl* m_webSchedulerImpl;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; // 不能用wtf的函数，否则退出后wtf被关闭了，就不能访问了&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; std::vector&amp;lt;WebTimerBase*&amp;gt; m_timerHeap;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; std::vector&amp;lt;WebTimerBase*&amp;gt; m_unusedTimersToDelete;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; std::vector&amp;lt;TaskPair*&amp;gt; m_taskPairsToPost;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; std::vector&amp;lt;TaskObserver*&amp;gt; m_observers;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_isObserversDirty;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; const char* m_name;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CRITICAL_SECTION m_taskPairsMutex;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; CRITICAL_SECTION m_observersMutex;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_suspendTimerQueue;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_hadThreadInit;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; HANDLE m_threadHandle;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; double m_currentFrameCreateTime; // 当前帧全部使用这个创建时间&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; static unsigned m_currentHeapInsertionOrder;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; bool m_isMainThread;&lt;/div&gt;&lt;div&gt;};&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;align=left;" vertex="1" parent="1">
          <mxGeometry x="290" y="-1320" width="1080" height="1570" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
